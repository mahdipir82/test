{% extends "maintemplate.html" %}
{% load static %}
{% block content %}
<div>
    <div class="container mx-auto px-4 py-16">

        <!-- Header -->
        <div class="flex items-center gap-4 mb-8">
            <div class="w-16 h-16 bg-gradient-to-r from-[#008B8B] to-[#006666] rounded-2xl flex items-center justify-center text-white text-2xl font-bold">
                Ú©
            </div>
            <div>
                <h2 class="text-4xl font-bold dark:text-white">Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø±ÛŒ</h2>
                <p class="text-gray-600 dark:text-gray-400" id="userWelcome">Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!</p>
            </div>
        </div>

        <div class="grid lg:grid-cols-3 gap-8">
            <!-- Main content -->
            <div class="lg:col-span-2 space-y-8">

                <!-- Purchase History -->
                <div class="form-glass p-6 rounded-2xl">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold dark:text-white flex items-center gap-3">
                            <span class="text-3xl">ğŸ›ï¸</span> ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø®Ø±ÛŒØ¯Ù‡Ø§
                        </h3>
                        <span class="bg-[#008B8B] text-white px-3 py-1 rounded-full text-sm font-bold" id="purchaseCount">0 Ø®Ø±ÛŒØ¯</span>
                    </div>
                    <div id="userPurchases" class="space-y-4"></div>
                </div>

                <!-- Addresses -->
                <div class="form-glass p-6 rounded-2xl">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold dark:text-white flex items-center gap-3">
                            <span class="text-3xl">ğŸ“</span> Ø¢Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ Ù…Ù†
                        </h3>
                        <button onclick="addAddress()" class="btn-primary btn-modern px-4 py-2 rounded-xl text-sm font-medium">Ø§ÙØ²ÙˆØ¯Ù† Ø¢Ø¯Ø±Ø³</button>
                    </div>
<div id="userAddresses" class="space-y-4">
    {% if user_addresses %}
        {% for address in user_addresses %}
            <div class="bg-gray-100 dark:bg-gray-800 p-3 rounded-xl">
                <p class="font-bold">{{ address.title }}</p>
                <p class="text-sm">{{ address.full_address }}</p>
                <p class="text-sm">{{ address.city }}, {{ address.province }} - Ú©Ø¯ Ù¾Ø³ØªÛŒ: {{ address.postal_code }}</p>
                <div class="flex gap-2 mt-2">
                    <button onclick="openAddressModal({id: {{ address.id }}, title: '{{ address.title|escapejs }}', province: '{{ address.province|escapejs }}', city: '{{ address.city|escapejs }}', full_address: '{{ address.full_address|escapejs }}', postal_code: '{{ address.postal_code|escapejs }}'})" class="px-3 py-1 bg-blue-500 text-white rounded-lg text-sm">ÙˆÛŒØ±Ø§ÛŒØ´</button>
                    <button onclick="deleteAddress({{ address.id }})" class="px-3 py-1 bg-red-500 text-white rounded-lg text-sm">Ø­Ø°Ù</button>
                </div>
            </div>
        {% endfor %}
    {% else %}
        <p class="text-gray-500 dark:text-gray-300">Ù‡ÛŒÚ† Ø¢Ø¯Ø±Ø³ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>
    {% endif %}
</div>
                </div>
            </div>
            
            <!-- Current Cart -->
                     <div class="form-glass p-6 rounded-2xl">
                <h3 class="text-xl font-bold mb-4 dark:text-white flex items-center gap-3">
                    <span class="text-2xl">ğŸ›’</span>Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ ÙØ¹Ù„ÛŒ
                </h3>

                <div id="profileCart" class="space-y-4" data-cart='{{ profile_cart_json|default:"[]"|escapejs }}'>
                    {% if profile_cart_items %}
                        {% for item in profile_cart_items %}
                            <div class="flex items-center justify-between bg-gray-100 dark:bg-gray-800 p-3 rounded-xl">
                                <div>
                                    <p class="font-bold">{{ item.title|default:item.name|default:"Ù…Ø­ØµÙˆÙ„" }}</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">{{ item.price|default:0 }} ØªÙˆÙ…Ø§Ù†</p>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-6">
                            <p class="text-gray-500 dark:text-gray-300">Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ ÙØ¹Ù„ÛŒ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª</p>
                        </div>
                    {% endif %}
                </div>

                <!-- Ø¯Ú©Ù…Ù‡ Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ -->
                <button onclick="finalizeOrder()"
                        class="btn-primary btn-modern w-full py-3 mt-4 rounded-xl text-center">
                    Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ Ù†Ù‡Ø§ÛŒÛŒ
                </button>
            </div>
            <!-- Sidebar -->
            <div class="space-y-8">

                <!-- Profile Card -->
                <div x-data="{ openProfileModal: false }" class="space-y-8">

                    <div class="form-glass p-6 rounded-2xl">
                        <h3 class="text-xl font-bold mb-4 dark:text-white flex items-center gap-3">
                            <span class="text-2xl">ğŸ‘¤</span> Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø±ÛŒ
                        </h3>

                        <div class="space-y-4">
                            <div class="flex justify-between"><span class="text-gray-600">Ù†Ø§Ù…:</span><span id="showName" class="font-bold">{{ user_data.name }}</span></div>
                            <div class="flex justify-between"><span class="text-gray-600">Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ:</span><span id="showFamily" class="font-bold">{{ user_data.family }}</span></div>
                            <div class="flex justify-between"><span class="text-gray-600">Ø§ÛŒÙ…ÛŒÙ„:</span><span id="showEmail" class="font-bold">{{ user_data.email }}</span></div>
                            <div class="flex justify-between"><span class="text-gray-600">Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„:</span><span id="showMobile" class="font-bold">{{ user_data.mobile_number }}</span></div>
                            <div class="flex justify-between"><span class="text-gray-600">Ú©Ø¯ Ù…Ù„ÛŒ:</span><span id="showNational" class="font-bold">{{ customer_data.national_code }}</span></div>
                            <div class="flex justify-between"><span class="text-gray-600">ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯:</span><span id="showBirth" class="font-bold">{{ customer_data.birth_date }}</span></div>
                        </div>

                        <div class="mt-6 text-center">
                            <button @click="openProfileModal = true" class="px-4 py-2 bg-blue-600 text-white rounded-lg">ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÙØ§ÛŒÙ„</button>
                        </div>
                    </div>

                    <!-- Edit Modal -->
                    <div x-show="openProfileModal" x-cloak class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50" x-transition.opacity>
                        <div class="bg-white dark:bg-gray-900 w-full max-w-lg p-6 rounded-2xl shadow-xl relative" x-transition.scale>
                            <button @click="openProfileModal = false" class="absolute top-2 right-3 text-gray-500 text-xl font-bold">âœ–</button>
                            <h2 class="text-2xl font-bold mb-4 text-center dark:text-white">ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÙØ§ÛŒÙ„</h2>

                            <form id="profileForm" method="POST">
                                {% csrf_token %}
                                <div>
                                    <label class="block mb-1">Ù†Ø§Ù…</label>
                                    <input type="text" name="name" id="profileName" value="{{ user_data.name }}" class="w-full p-2 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block mb-1">Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ</label>
                                    <input type="text" name="family" id="profileFamily" value="{{ user_data.family }}" class="w-full p-2 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block mb-1">Ø§ÛŒÙ…ÛŒÙ„</label>
                                    <input type="email" name="email" id="profileEmail" value="{{ user_data.email }}" class="w-full p-2 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block mb-1">Ú©Ø¯ Ù…Ù„ÛŒ</label>
                                    <input type="text" name="national_code" id="profileNationalCode" value="{{ customer_data.national_code }}" class="w-full p-2 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block mb-1">ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯</label>
                                    <input type="date" name="birth_date" id="profileBirthDate" value="{{ customer_data.birth_date }}" class="w-full p-2 border rounded-lg">
                                </div>
                                <div class="flex justify-between mt-4">
                                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
                                    <button type="button" @click="openProfileModal = false" class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Ù„ØºÙˆ</button>
                                </div>
                            </form>
                        </div>
                    </div>

                </div>
                    <div class="form-glass p-6 rounded-2xl">
                        <h3 class="text-xl font-bold mb-4 dark:text-white flex items-center gap-3"><span
                                class="text-2xl">ğŸ“Š</span> Ø¢Ù…Ø§Ø± Ø®Ø±ÛŒØ¯</h3>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center"><span
                                    class="text-gray-600 dark:text-gray-400">Ú©Ù„ Ø®Ø±ÛŒØ¯Ù‡Ø§:</span> <span
                                    class="font-bold dark:text-white" id="totalPurchases">0</span>
                            </div>
                            <div class="flex justify-between items-center"><span
                                    class="text-gray-600 dark:text-gray-400">Ú©Ù„ Ù…Ø¨Ù„Øº:</span> <span
                                    class="font-bold text-[#008B8B]" id="totalSpent">0 ØªÙˆÙ…Ø§Ù†</span>
                            </div>
                            <div class="flex justify-between items-center"><span
                                    class="text-gray-600 dark:text-gray-400">Ø¢Ø®Ø±ÛŒÙ† Ø®Ø±ÛŒØ¯:</span> <span
                                    class="font-bold dark:text-white" id="lastPurchase">-</span>
                            </div>
                        </div>
                    </div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/alpinejs" defer></script>
<script>
document.addEventListener("DOMContentLoaded", async () => {
    // ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø¢Ù¾Ø¯ÛŒØª Ø¨Ø¹Ø¯ Ø§Ø² submitØŒ Ú†ÙˆÙ† Ù…Ù‚Ø§Ø¯ÛŒØ± Ø§ÙˆÙ„ÛŒÙ‡ Ø§Ø² context Ù„ÙˆØ¯ Ø´Ø¯Ù‡
    document.getElementById("profileForm").addEventListener("submit", async function(e){
        e.preventDefault();
        const formData = new FormData(this);

        const res = await fetch("/accounts/profile/update/api/", {
            method: "POST",
            body: formData,
            headers: { "X-Requested-With": "XMLHttpRequest" },
            credentials: "include"
        });

        const data = await res.json();

        if(data.success){
            showNotification(data.message || "Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯!");

            document.getElementById("showName").textContent = data.user.name;
            document.getElementById("showFamily").textContent = data.user.family;
            document.getElementById("showEmail").textContent = data.user.email;
            document.getElementById("showNational").textContent = data.user.national_code;
            document.getElementById("showBirth").textContent = data.user.birth_date || "-";

            const modal = document.querySelector("[x-data]");
            if(modal && modal.__x) modal.__x.$data.openProfileModal = false;
        } else {
            showNotification(data.message || "Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„!");
        }
    });
  renderProfileCart();
  renderProfilePurchases();
});

function renderProfileCart(){
    const cartContainer = document.getElementById("profileCart");
    if(!cartContainer) return;

    let cartData = [];
    try {
        cartData = (typeof cart !== "undefined" && Array.isArray(cart) && cart.length)
            ? cart
            : JSON.parse(cartContainer.dataset.cart || "[]");
    } catch (e) {
        cartData = [];
    }

    if(!Array.isArray(cartData) || cartData.length === 0){
        cartContainer.innerHTML = `<div class="text-center py-6"><p class="text-gray-500 dark:text-gray-300">Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ ÙØ¹Ù„ÛŒ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª</p></div>`;
        return;
    }
    if (typeof cart !== "undefined" && (!Array.isArray(cart) || cart.length === 0) && cartData.length) {
        cart = cartData;
        if (typeof saveCart === "function") saveCart();
        if (typeof updateCartBadge === "function") updateCartBadge();
    }   
    let totalPrice = 0;
    cartContainer.innerHTML = cartData.map(item => {
        const quantity = item.quantity || item.count || 1;
        const price = item.discountPercent > 0 ? (item.finalPrice || item.price || 0) : (item.price || item.unit_price || 0);
        const lineTotal = item.total_price || price * quantity;
        totalPrice += lineTotal;
        const stock = item.stock_quantity || item.stock || null;
        return `
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 bg-gray-100 dark:bg-gray-800 p-3 rounded-xl">
                <div>
                    <p class="font-bold">${item.title || item.name || "Ù…Ø­ØµÙˆÙ„"}</p>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯: ${(price || 0).toLocaleString()} ØªÙˆÙ…Ø§Ù†</p>
                     <p class="text-sm text-gray-600 dark:text-gray-400">${stock ? `Ù…ÙˆØ¬ÙˆØ¯ÛŒ: ${stock}` : ""}</p>
                </div>
                <div class="flex items-center gap-2">
                    <button data-action="dec" data-id="${item.id}" class="w-8 h-8 bg-gray-200 dark:bg-gray-700 rounded">âˆ’</button>
                    <span class="font-bold">${quantity}</span>
                    <button data-action="inc" data-id="${item.id}" class="w-8 h-8 bg-gray-200 dark:bg-gray-700 rounded">+</button>
                </div>
                <div class="text-right">
                    <div class="font-bold text-[#008B8B]">${lineTotal.toLocaleString()} ØªÙˆÙ…Ø§Ù†</div>
                    <button data-action="remove" data-id="${item.id}" class="text-sm text-red-500 mt-1">Ø­Ø°Ù</button>
                </div>
                
            </div>`;
    }).join("");

    cartContainer.innerHTML += `<div class="flex justify-between items-center bg-white dark:bg-gray-900 p-3 rounded-xl border mt-2"><span class="font-bold">Ø¬Ù…Ø¹ Ú©Ù„</span><span class="font-bold text-[#008B8B]">${totalPrice.toLocaleString()} ØªÙˆÙ…Ø§Ù†</span></div>`;
}    
cartContainer.querySelectorAll('[data-action="inc"]').forEach(btn => btn.addEventListener('click', () => updateProfileCartItem(btn.dataset.id, 1)));
    cartContainer.querySelectorAll('[data-action="dec"]').forEach(btn => btn.addEventListener('click', () => updateProfileCartItem(btn.dataset.id, -1)));
    cartContainer.querySelectorAll('[data-action="remove"]').forEach(btn => btn.addEventListener('click', () => removeProfileCartItem(btn.dataset.id)));
}

function updateProfileCartItem(id, change){
    if (typeof cart === "undefined" || !Array.isArray(cart)) return;
    const item = cart.find(i => String(i.id) === String(id));
    if(!item) return;

    const stock = item.stock_quantity || item.stock || Infinity;
    const newQuantity = (item.quantity || 1) + change;

    if(newQuantity > stock){
        showNotification("Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª", "error");
        return;
    }

    if(newQuantity <= 0){
        removeProfileCartItem(id);
        return;
    }

    item.quantity = newQuantity;
    if (typeof saveCart === "function") saveCart();
    if (typeof updateCartBadge === "function") updateCartBadge();
    renderProfileCart();
}

function removeProfileCartItem(id){
    if (typeof cart === "undefined" || !Array.isArray(cart)) return;
    cart = cart.filter(i => String(i.id) !== String(id));
    if (typeof saveCart === "function") saveCart();
    if (typeof updateCartBadge === "function") updateCartBadge();
    renderProfileCart();
}

function getPurchaseHistory(){
    try{
        const stored = JSON.parse(localStorage.getItem("purchaseHistory") || "[]");
        return Array.isArray(stored) ? stored : [];
    }catch(err){
        return [];
    }
}

function savePurchaseHistory(history){
    localStorage.setItem("purchaseHistory", JSON.stringify(history));
}

function renderProfilePurchases(){
    const userPurchases = document.getElementById("userPurchases");
    const purchaseCountElement = document.getElementById("purchaseCount");
    const totalPurchases = document.getElementById("totalPurchases");
    const totalSpent = document.getElementById("totalSpent");
    const lastPurchase = document.getElementById("lastPurchase");

    if(!userPurchases) return;

    const history = getPurchaseHistory();

    if(history.length === 0){
        if (purchaseCountElement) purchaseCountElement.textContent = "0 Ø®Ø±ÛŒØ¯";
        userPurchases.innerHTML = `<p class="text-gray-500 dark:text-gray-300">Ù‡Ù†ÙˆØ² Ù‡ÛŒÚ† Ø®Ø±ÛŒØ¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>`;
        if (totalPurchases) totalPurchases.textContent = "0";
        if (totalSpent) totalSpent.textContent = "0 ØªÙˆÙ…Ø§Ù†";
        if (lastPurchase) lastPurchase.textContent = "-";
        return;
    }

    if (purchaseCountElement) purchaseCountElement.textContent = `${history.length} Ø®Ø±ÛŒØ¯`;

    userPurchases.innerHTML = history.map(purchase => {
        const itemsList = Array.isArray(purchase.items) ? purchase.items.map(it => `<li class="text-sm text-gray-600 dark:text-gray-400">${it.quantity} Ã— ${it.title || it.name || "Ù…Ø­ØµÙˆÙ„"}</li>`).join("") : "";
        return `
            <div class="bg-gray-100 dark:bg-gray-800 p-4 rounded-xl space-y-2">
                <div class="flex items-center justify-between">
                    <p class="font-bold">${purchase.title || "Ø³ÙØ§Ø±Ø´"}</p>
                    <span class="text-sm text-gray-500">${purchase.purchaseDate || ""}</span>
                </div>
                ${itemsList ? `<ul class="list-disc list-inside">${itemsList}</ul>` : ""}
                <p class="font-bold text-[#008B8B]">${(purchase.total || purchase.price || 0).toLocaleString()} ØªÙˆÙ…Ø§Ù†</p>
            </div>
        `;
    }).join("");

    const totalAmount = history.reduce((sum, p) => sum + (p.total || p.price || 0), 0);
    if (totalPurchases) totalPurchases.textContent = history.length;
    if (totalSpent) totalSpent.textContent = `${totalAmount.toLocaleString()} ØªÙˆÙ…Ø§Ù†`;
    if (lastPurchase) lastPurchase.textContent = history[history.length - 1].purchaseDate || "-";
}

function finalizeOrder(){
    if (typeof cart === "undefined" || !Array.isArray(cart) || cart.length === 0){
        showNotification('Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ ÙØ¹Ù„ÛŒ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª!', 'error');
        return;
    }

    const purchaseDate = new Date().toLocaleDateString('fa-IR');
    const items = cart.map(item => {
        const quantity = item.quantity || 1;
        const unitPrice = item.discountPercent > 0 ? (item.finalPrice || item.price || 0) : (item.price || 0);
        return {
            id: item.id,
            title: item.name || item.title || "Ù…Ø­ØµÙˆÙ„",
            quantity,
            unit_price: unitPrice,
            total_price: unitPrice * quantity
        };
    });

    const total = items.reduce((sum, it) => sum + (it.total_price || 0), 0);
    const history = getPurchaseHistory();
    const newOrder = {
        id: `order-${Date.now()}`,
        title: `Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§Ø±Ù‡ ${history.length + 1}`,
        purchaseDate,
        items,
        total
    };

    history.push(newOrder);
    savePurchaseHistory(history);
    renderProfilePurchases();

    showNotification('Ø§ÛŒÙ† Ø³Ø§ÛŒØª ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø±Ø²ÙˆÙ…Ù‡ Ø§Ø³Øª Ùˆ Ù‚Ø§Ø¨Ù„ÛŒØª ÙØ±ÙˆØ´ Ù†Ø¯Ø§Ø±Ø¯.', 'info');

    cart = [];
    if (typeof saveCart === "function") saveCart();
    if (typeof updateCartBadge === "function") updateCartBadge();
    renderProfileCart();
}
</script>
{% endblock %}
