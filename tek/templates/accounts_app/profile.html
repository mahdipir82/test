{% extends "maintemplate.html" %}
{% load static %}
{% block content %}
<div>
    <div class="container mx-auto px-4 py-16">

        <!-- Header -->
        <div class="flex items-center gap-4 mb-8">
            <div class="w-16 h-16 bg-gradient-to-r from-[#008B8B] to-[#006666] rounded-2xl flex items-center justify-center text-white text-2xl font-bold">
                Ú©
            </div>
            <div>
                <h2 class="text-4xl font-bold dark:text-white">Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø±ÛŒ</h2>
                <p class="text-gray-600 dark:text-gray-400" id="userWelcome">Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!</p>
            </div>
        </div>

        <div class="grid lg:grid-cols-3 gap-8">
            <!-- Main content -->
            <div class="lg:col-span-2 space-y-8">

                <!-- Purchase History -->
                <div class="form-glass p-6 rounded-2xl">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold dark:text-white flex items-center gap-3">
                            <span class="text-3xl">ğŸ›ï¸</span> ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø®Ø±ÛŒØ¯Ù‡Ø§
                        </h3>
                        <span class="bg-[#008B8B] text-white px-3 py-1 rounded-full text-sm font-bold" id="purchaseCount">0 Ø®Ø±ÛŒØ¯</span>
                    </div>
                    <div id="userPurchases" class="space-y-4"></div>
                </div>

                <!-- Addresses -->
                <div class="form-glass p-6 rounded-2xl">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold dark:text-white flex items-center gap-3">
                            <span class="text-3xl">ğŸ“</span> Ø¢Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ Ù…Ù†
                        </h3>
                        <button onclick="addAddress()" class="btn-primary btn-modern px-4 py-2 rounded-xl text-sm font-medium">Ø§ÙØ²ÙˆØ¯Ù† Ø¢Ø¯Ø±Ø³</button>
                    </div>
<div id="userAddresses" class="space-y-4">
    {% if user_addresses %}
        {% for address in user_addresses %}
            <div class="bg-gray-100 dark:bg-gray-800 p-3 rounded-xl">
                <p class="font-bold">{{ address.title }}</p>
                <p class="text-sm">{{ address.full_address }}</p>
                <p class="text-sm">{{ address.city }}, {{ address.province }} - Ú©Ø¯ Ù¾Ø³ØªÛŒ: {{ address.postal_code }}</p>
            </div>
        {% endfor %}
    {% else %}
        <p class="text-gray-500 dark:text-gray-300">Ù‡ÛŒÚ† Ø¢Ø¯Ø±Ø³ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>
    {% endif %}
</div>
                </div>
            </div>
            
            <!-- Current Cart -->
                     <div class="form-glass p-6 rounded-2xl">
                <h3 class="text-xl font-bold mb-4 dark:text-white flex items-center gap-3">
                    <span class="text-2xl">ğŸ›’</span>Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ ÙØ¹Ù„ÛŒ
                </h3>

                <div id="profileCart" class="space-y-4" data-cart='{{ profile_cart_json|default:"[]"|escapejs }}'>
                    {% if profile_cart_items %}
                        {% for item in profile_cart_items %}
                            <div class="flex items-center justify-between bg-gray-100 dark:bg-gray-800 p-3 rounded-xl">
                                <div>
                                    <p class="font-bold">{{ item.title|default:item.name|default:"Ù…Ø­ØµÙˆÙ„" }}</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">{{ item.price|default:0 }} ØªÙˆÙ…Ø§Ù†</p>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-6">
                            <p class="text-gray-500 dark:text-gray-300">Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ ÙØ¹Ù„ÛŒ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª</p>
                        </div>
                    {% endif %}
                </div>

                <!-- Ø¯Ú©Ù…Ù‡ Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ -->
                <button onclick="finalizeOrder()"
                        class="btn-primary btn-modern w-full py-3 mt-4 rounded-xl text-center">
                    Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ Ù†Ù‡Ø§ÛŒÛŒ
                </button>
            </div>
            <!-- Sidebar -->
            <div class="space-y-8">

                <!-- Profile Card -->
                <div x-data="{ openProfileModal: false }" class="space-y-8">

                    <div class="form-glass p-6 rounded-2xl">
                        <h3 class="text-xl font-bold mb-4 dark:text-white flex items-center gap-3">
                            <span class="text-2xl">ğŸ‘¤</span> Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø±ÛŒ
                        </h3>

                        <div class="space-y-4">
                            <div class="flex justify-between"><span class="text-gray-600">Ù†Ø§Ù…:</span><span id="showName" class="font-bold">{{ user_data.name }}</span></div>
                            <div class="flex justify-between"><span class="text-gray-600">Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ:</span><span id="showFamily" class="font-bold">{{ user_data.family }}</span></div>
                            <div class="flex justify-between"><span class="text-gray-600">Ø§ÛŒÙ…ÛŒÙ„:</span><span id="showEmail" class="font-bold">{{ user_data.email }}</span></div>
                            <div class="flex justify-between"><span class="text-gray-600">Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„:</span><span id="showMobile" class="font-bold">{{ user_data.mobile_number }}</span></div>
                            <div class="flex justify-between"><span class="text-gray-600">Ú©Ø¯ Ù…Ù„ÛŒ:</span><span id="showNational" class="font-bold">{{ customer_data.national_code }}</span></div>
                            <div class="flex justify-between"><span class="text-gray-600">ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯:</span><span id="showBirth" class="font-bold">{{ customer_data.birth_date }}</span></div>
                        </div>

                        <div class="mt-6 text-center">
                            <button @click="openProfileModal = true" class="px-4 py-2 bg-blue-600 text-white rounded-lg">ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÙØ§ÛŒÙ„</button>
                        </div>
                    </div>

                    <!-- Edit Modal -->
                    <div x-show="openProfileModal" x-cloak class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50" x-transition.opacity>
                        <div class="bg-white dark:bg-gray-900 w-full max-w-lg p-6 rounded-2xl shadow-xl relative" x-transition.scale>
                            <button @click="openProfileModal = false" class="absolute top-2 right-3 text-gray-500 text-xl font-bold">âœ–</button>
                            <h2 class="text-2xl font-bold mb-4 text-center dark:text-white">ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÙØ§ÛŒÙ„</h2>

                            <form id="profileForm" method="POST">
                                {% csrf_token %}
                                <div>
                                    <label class="block mb-1">Ù†Ø§Ù…</label>
                                    <input type="text" name="name" id="profileName" value="{{ user_data.name }}" class="w-full p-2 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block mb-1">Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ</label>
                                    <input type="text" name="family" id="profileFamily" value="{{ user_data.family }}" class="w-full p-2 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block mb-1">Ø§ÛŒÙ…ÛŒÙ„</label>
                                    <input type="email" name="email" id="profileEmail" value="{{ user_data.email }}" class="w-full p-2 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block mb-1">Ú©Ø¯ Ù…Ù„ÛŒ</label>
                                    <input type="text" name="national_code" id="profileNationalCode" value="{{ customer_data.national_code }}" class="w-full p-2 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block mb-1">ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯</label>
                                    <input type="date" name="birth_date" id="profileBirthDate" value="{{ customer_data.birth_date }}" class="w-full p-2 border rounded-lg">
                                </div>
                                <div class="flex justify-between mt-4">
                                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
                                    <button type="button" @click="openProfileModal = false" class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Ù„ØºÙˆ</button>
                                </div>
                            </form>
                        </div>
                    </div>

                </div>
                    <div class="form-glass p-6 rounded-2xl">
                        <h3 class="text-xl font-bold mb-4 dark:text-white flex items-center gap-3"><span
                                class="text-2xl">ğŸ“Š</span> Ø¢Ù…Ø§Ø± Ø®Ø±ÛŒØ¯</h3>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center"><span
                                    class="text-gray-600 dark:text-gray-400">Ú©Ù„ Ø®Ø±ÛŒØ¯Ù‡Ø§:</span> <span
                                    class="font-bold dark:text-white" id="totalPurchases">0</span>
                            </div>
                            <div class="flex justify-between items-center"><span
                                    class="text-gray-600 dark:text-gray-400">Ú©Ù„ Ù…Ø¨Ù„Øº:</span> <span
                                    class="font-bold text-[#008B8B]" id="totalSpent">0 ØªÙˆÙ…Ø§Ù†</span>
                            </div>
                            <div class="flex justify-between items-center"><span
                                    class="text-gray-600 dark:text-gray-400">Ø¢Ø®Ø±ÛŒÙ† Ø®Ø±ÛŒØ¯:</span> <span
                                    class="font-bold dark:text-white" id="lastPurchase">-</span>
                            </div>
                        </div>
                    </div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/alpinejs" defer></script>
<script>
document.addEventListener("DOMContentLoaded", async () => {
    // ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø¢Ù¾Ø¯ÛŒØª Ø¨Ø¹Ø¯ Ø§Ø² submitØŒ Ú†ÙˆÙ† Ù…Ù‚Ø§Ø¯ÛŒØ± Ø§ÙˆÙ„ÛŒÙ‡ Ø§Ø² context Ù„ÙˆØ¯ Ø´Ø¯Ù‡
    document.getElementById("profileForm").addEventListener("submit", async function(e){
        e.preventDefault();
        const formData = new FormData(this);

        const res = await fetch("accounts/profile/update/api/", {
            method: "POST",
            body: formData,
            headers: { "X-Requested-With": "XMLHttpRequest" },
            credentials: "include"
        });

        const data = await res.json();

        if(data.success){
            showNotification(data.message || "Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯!");

            document.getElementById("showName").textContent = data.user.name;
            document.getElementById("showFamily").textContent = data.user.family;
            document.getElementById("showEmail").textContent = data.user.email;
            document.getElementById("showNational").textContent = data.user.national_code;
            document.getElementById("showBirth").textContent = data.user.birth_date || "-";

            const modal = document.querySelector("[x-data]");
            if(modal && modal.__x) modal.__x.$data.openProfileModal = false;
        } else {
            showNotification(data.message || "Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„!");
        }
    });
});    

</script>
{% endblock %}
